<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button[type="submit"], .btn-primary {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button[type="submit"]:hover, .btn-primary:hover {
            background: #764ba2;
        }

        .btn-secondary {
            background: #00b894;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn-export {
            background: #fdcb6e;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            background: #e17055;
            color: white;
        }

        .btn-danger {
            background: #d63031;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .card p {
            color: #666;
            margin: 5px 0;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-success {
            background: #55efc4;
            color: #00b894;
        }

        .badge-warning {
            background: #fdcb6e;
            color: #e17055;
        }

        .badge-info {
            background: #74b9ff;
            color: #0984e3;
        }

        .success-message {
            background: #55efc4;
            color: #00b894;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h2 {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: rgba(255,255,255,0.9);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .rubric-item {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rubric-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .criterion-grade {
            background: #fff;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        small {
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ“š Instructor Portal</h1>
        <div class="user-info">
            <div class="user-badge" id="userBadge">ID: Loading...</div>
            <span id="userName">Welcome, Instructor</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <h2 id="classCount">0</h2>
                <p>My Classes</p>
            </div>
            <div class="stat-card">
                <h2 id="assignmentCount">0</h2>
                <p>Total Assignments</p>
            </div>
            <div class="stat-card">
                <h2 id="submissionCount">0</h2>
                <p>Pending Reviews</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('classes')">My Classes</button>
            <button class="tab" onclick="showTab('createClass')">Create Class</button>
            <button class="tab" onclick="showTab('assignments')">Assignments</button>
            <button class="tab" onclick="showTab('createAssignment')">Create Assignment</button>
            <button class="tab" onclick="showTab('submissions')">Grade Submissions</button>
            <button class="tab" onclick="showTab('enrollment')">Manage Students</button>
        </div>

        <div id="classes" class="tab-content active">
            <h2>My Classes</h2>
            <div id="classesList"></div>
        </div>

        <div id="createClass" class="tab-content">
            <h2>Create New Class</h2>
            <form onsubmit="createClass(event)">
                <div class="form-group">
                    <label for="classCode">Class Code *</label>
                    <input type="text" id="classCode" required placeholder="e.g., COM569" maxlength="20">
                </div>

                <div class="form-group">
                    <label for="className">Class Name *</label>
                    <input type="text" id="className" required placeholder="e.g., Software Engineering and Project Management">
                </div>

                <div class="form-group">
                    <label for="classDescription">Description</label>
                    <textarea id="classDescription" placeholder="Describe the course content and objectives..."></textarea>
                </div>

                <button type="submit">Create Class</button>
            </form>
        </div>

        <div id="assignments" class="tab-content">
            <h2>All My Assignments</h2>
            <div class="form-group">
                <label for="filterClass">Filter by Class</label>
                <select id="filterClass" onchange="loadAssignments()">
                    <option value="">All Classes</option>
                </select>
            </div>
            <div id="assignmentsList"></div>
        </div>

        <div id="createAssignment" class="tab-content">
            <h2>Create New Assignment</h2>
            <form onsubmit="createAssignment(event)">
                <div class="form-group">
                    <label for="assignmentClass">Select Class *</label>
                    <select id="assignmentClass" required>
                        <option value="">-- Choose a Class --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">Assignment Title *</label>
                    <input type="text" id="title" required placeholder="e.g., Database Design Project">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="Assignment requirements and instructions..."></textarea>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="dueDate">Due Date *</label>
                        <input type="datetime-local" id="dueDate" required>
                    </div>

                    <div class="form-group">
                        <label for="maxPoints">Maximum Points</label>
                        <input type="number" id="maxPoints" value="100" min="1">
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Grading Rubric (Optional)</h3>
                <p style="color: #666; margin-bottom: 20px;">Define criteria for grading this assignment. Total rubric points should equal max points.</p>

                <div id="rubricsList"></div>

                <div class="rubric-form">
                    <h4>Add Criterion</h4>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="criterionName">Criterion Name</label>
                            <input type="text" id="criterionName" placeholder="e.g., Code Quality">
                        </div>
                        <div class="form-group">
                            <label for="criterionPoints">Max Points</label>
                            <input type="number" id="criterionPoints" placeholder="e.g., 30" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="criterionDesc">Description (Optional)</label>
                        <input type="text" id="criterionDesc" placeholder="e.g., Clean, readable code with proper comments">
                    </div>
                    <button type="button" class="btn-secondary" onclick="addRubricCriterion()">+ Add Criterion</button>
                </div>

                <button type="submit" style="margin-top: 20px;">Create Assignment</button>
            </form>
        </div>

        <div id="submissions" class="tab-content">
            <h2>Grade Student Submissions</h2>

            <div class="two-column">
                <div class="form-group">
                    <label for="submissionClass">Select Class</label>
                    <select id="submissionClass" onchange="loadClassAssignments()">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="submissionAssignment">Select Assignment</label>
                    <select id="submissionAssignment" onchange="loadSubmissions()">
                        <option value="">-- Select Assignment --</option>
                    </select>
                </div>
            </div>

            <div id="exportSection" style="display: none; margin-bottom: 20px;">
                <button class="btn-export" onclick="exportGradesCSV()">
                    ðŸ“Š Export Grades to CSV
                </button>
                <p style="color: #666; font-size: 13px; margin-top: 5px;">Download all grades for this assignment as a CSV file</p>
            </div>

            <div id="submissionsList"></div>
        </div>

        <div id="enrollment" class="tab-content">
            <h2>Manage Student Enrollment</h2>

            <div class="form-group">
                <label for="enrollClass">Select Class</label>
                <select id="enrollClass" onchange="loadEnrolledStudents()">
                    <option value="">-- Select Class --</option>
                </select>
            </div>

            <h3 style="margin-top: 30px;">Add Student to Class</h3>
            <form onsubmit="enrollStudent(event)" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label for="studentEmail">Student Email *</label>
                    <input type="email" id="studentEmail" required placeholder="e.g., alice.brown@wrexham.ac.uk">
                    <small>Enter the student's university email address</small>
                </div>

                <button type="submit">Enroll Student</button>
            </form>

            <h3>Enrolled Students</h3>
            <div id="enrolledStudentsList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chojny89.pythonanywhere.com';
        let currentUser = null;
        let myClasses = [];
        let rubricCriteria = [];
        let currentAssignmentRubrics = [];
        let currentAssignmentId = null;
        function checkAuth() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(user);

            if (currentUser.role !== 'instructor') {
                alert('Access denied. Instructors only.');
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('userName').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
            document.getElementById('userBadge').textContent = `ID: ${currentUser.unique_id}`;

            loadDashboard();
        }

        async function loadDashboard() {
            await loadClasses();
            await loadAssignments();
            updateStats();
        }

        function updateStats() {
            document.getElementById('classCount').textContent = myClasses.length;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showMessage(message, type = 'success') {
            const msgElement = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
            msgElement.textContent = message;
            msgElement.style.display = 'block';
            setTimeout(() => {
                msgElement.style.display = 'none';
            }, 5000);
        }

        async function createClass(event) {
            event.preventDefault();

            const data = {
                instructor_id: currentUser.user_id,
                class_code: document.getElementById('classCode').value.toUpperCase(),
                class_name: document.getElementById('className').value,
                description: document.getElementById('classDescription').value
            };

            try {
                const response = await fetch(`${API_URL}/classes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Class created successfully!');
                    document.querySelector('#createClass form').reset();
                    loadClasses();
                } else {
                    showMessage(result.error || 'Failed to create class', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function loadClasses() {
            try {
                const response = await fetch(`${API_URL}/classes?instructor_id=${currentUser.user_id}`);
                myClasses = await response.json();

                const html = myClasses.map(c => `
                    <div class="card">
                        <h3>${c.class_code} - ${c.class_name}</h3>
                        <p>${c.description || 'No description'}</p>
                        <span class="badge badge-info">Class ID: ${c.class_id}</span>

                        <div id="studentsList_${c.class_id}" style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 5px;">
                            <h4>Enrolled Students:</h4>
                            <div id="studentsContent_${c.class_id}">Loading...</div>
                        </div>

                        <div class="card-actions">
                            <button class="btn-primary" onclick="toggleClassStudents(${c.class_id})">
                                View Students
                            </button>
                            <button class="btn-danger" onclick="deleteClass(${c.class_id}, '${c.class_code}')">
                                Delete Class
                            </button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('classesList').innerHTML = html || '<p>No classes yet. Create your first class!</p>';

                populateClassDropdowns();
                updateStats();
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function toggleClassStudents(classId) {
            const studentsList = document.getElementById(`studentsList_${classId}`);
            const studentsContent = document.getElementById(`studentsContent_${classId}`);

            if (studentsList.style.display === 'none') {
                studentsList.style.display = 'block';

                try {
                    const response = await fetch(`${API_URL}/classes/${classId}/students`);
                    const students = await response.json();

                    if (students.length === 0) {
                        studentsContent.innerHTML = '<p style="color: #999;">No students enrolled yet.</p>';
                    } else {
                        const html = students.map(s => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${s.first_name} ${s.last_name}</strong> (${s.unique_id})
                                    <br>
                                    <small style="color: #666;">${s.email}</small>
                                </div>
                                <button class="btn-danger" style="padding: 6px 12px; font-size: 12px;"
                                        onclick="unenrollStudentFromClass(${s.enrollment_id}, '${s.first_name} ${s.last_name}', ${classId})">
                                    Remove
                                </button>
                            </div>
                        `).join('');

                        studentsContent.innerHTML = html + `
                            <p style="margin-top: 15px; color: #667eea; font-weight: 600;">
                                Total: ${students.length} student${students.length !== 1 ? 's' : ''}
                            </p>
                        `;
                    }
                } catch (error) {
                    studentsContent.innerHTML = '<p style="color: red;">Error loading students.</p>';
                }
            } else {
                studentsList.style.display = 'none';
            }
        }

        async function unenrollStudentFromClass(enrollmentId, studentName, classId) {
            if (!confirm(`Remove ${studentName} from this class?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/enrollments/${enrollmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage(`${studentName} removed successfully!`);
                    toggleClassStudents(classId);
                    toggleClassStudents(classId);
                } else {
                    showMessage('Failed to remove student', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function deleteClass(classId, classCode) {
            if (!confirm(`Delete class ${classCode}? This will also delete all assignments, submissions, and grades for this class. This cannot be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/classes/${classId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Class deleted successfully!');
                    loadClasses();
                    loadAssignments();
                } else {
                    showMessage('Failed to delete class', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function populateClassDropdowns() {
            const options = myClasses.map(c =>
                `<option value="${c.class_id}">${c.class_code} - ${c.class_name}</option>`
            ).join('');

            document.getElementById('assignmentClass').innerHTML =
                '<option value="">-- Choose a Class --</option>' + options;
            document.getElementById('filterClass').innerHTML =
                '<option value="">All Classes</option>' + options;
            document.getElementById('submissionClass').innerHTML =
                '<option value="">-- Select Class --</option>' + options;
            document.getElementById('enrollClass').innerHTML =
                '<option value="">-- Select Class --</option>' + options;
        }

        function addRubricCriterion() {
            const name = document.getElementById('criterionName').value;
            const points = document.getElementById('criterionPoints').value;
            const desc = document.getElementById('criterionDesc').value;

            if (!name || !points) {
                showMessage('Please enter criterion name and points', 'error');
                return;
            }

            rubricCriteria.push({
                criterion_name: name,
                max_points: parseFloat(points),
                description: desc
            });

            displayRubricCriteria();

            document.getElementById('criterionName').value = '';
            document.getElementById('criterionPoints').value = '';
            document.getElementById('criterionDesc').value = '';
        }

        function displayRubricCriteria() {
            const html = rubricCriteria.map((r, index) => `
                <div class="rubric-item">
                    <div>
                        <strong>${r.criterion_name}</strong> - ${r.max_points} points
                        ${r.description ? `<br><small>${r.description}</small>` : ''}
                    </div>
                    <button type="button" class="btn-danger" onclick="removeRubricCriterion(${index})">Remove</button>
                </div>
            `).join('');

            const total = rubricCriteria.reduce((sum, r) => sum + r.max_points, 0);
            const summary = rubricCriteria.length > 0 ? `<p style="margin-top: 10px;"><strong>Total Rubric Points: ${total}</strong></p>` : '';

            document.getElementById('rubricsList').innerHTML = html + summary;
        }

        function removeRubricCriterion(index) {
            rubricCriteria.splice(index, 1);
            displayRubricCriteria();
        }

        async function createAssignment(event) {
            event.preventDefault();

            const classId = document.getElementById('assignmentClass').value;

            if (!classId) {
                showMessage('Please select a class', 'error');
                return;
            }

            const data = {
                class_id: parseInt(classId),
                instructor_id: currentUser.user_id,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                due_date: document.getElementById('dueDate').value + ':00',
                max_points: parseInt(document.getElementById('maxPoints').value)
            };

            try {
                const response = await fetch(`${API_URL}/assignments`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    const assignmentId = result.assignment_id;

                    for (const criterion of rubricCriteria) {
                        await fetch(`${API_URL}/rubrics`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                assignment_id: assignmentId,
                                ...criterion
                            })
                        });
                    }

                    showMessage(`Assignment created successfully with ${rubricCriteria.length} rubric criteria!`);
                    document.querySelector('#createAssignment form').reset();
                    rubricCriteria = [];
                    displayRubricCriteria();
                    loadAssignments();
                } else {
                    showMessage('Failed to create assignment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function loadAssignments() {
            const filterClassId = document.getElementById('filterClass').value;

            try {
                let url = `${API_URL}/assignments?instructor_id=${currentUser.user_id}`;
                if (filterClassId) {
                    url += `&class_id=${filterClassId}`;
                }

                const response = await fetch(url);
                const assignments = await response.json();

                const html = assignments.map(a => `
                    <div class="card">
                        <h3>${a.title}</h3>
                        <p><strong>Class:</strong> ${a.class_code} - ${a.class_name}</p>
                        <p><strong>Due:</strong> ${new Date(a.due_date).toLocaleString()}</p>
                        <p><strong>Max Points:</strong> ${a.max_points}</p>
                        <p>${a.description || 'No description'}</p>
                        <span class="badge badge-info">ID: ${a.assignment_id}</span>
                        <div class="card-actions">
                            <button class="btn-danger" onclick="deleteAssignment(${a.assignment_id}, '${a.title}')">
                                Delete Assignment
                            </button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('assignmentsList').innerHTML = html || '<p>No assignments yet.</p>';
                document.getElementById('assignmentCount').textContent = assignments.length;
            } catch (error) {
                console.error('Error loading assignments:', error);
            }
        }

        async function deleteAssignment(assignmentId, title) {
            if (!confirm(`Delete assignment "${title}"? This will also delete all submissions and grades. This cannot be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/assignments/${assignmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Assignment deleted successfully!');
                    loadAssignments();
                } else {
                    showMessage('Failed to delete assignment', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        async function loadClassAssignments() {
            const classId = document.getElementById('submissionClass').value;

            if (!classId) {
                document.getElementById('submissionAssignment').innerHTML = '<option value="">-- Select Assignment --</option>';
                document.getElementById('exportSection').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/assignments?class_id=${classId}`);
                const assignments = await response.json();

                const options = assignments.map(a =>
                    `<option value="${a.assignment_id}">${a.title}</option>`
                ).join('');

                document.getElementById('submissionAssignment').innerHTML =
                    '<option value="">-- Select Assignment --</option>' + options;
            } catch (error) {
                console.error('Error loading assignments:', error);
            }
        }

        async function loadSubmissions() {
            const assignmentId = document.getElementById('submissionAssignment').value;
            currentAssignmentId = assignmentId;

            if (!assignmentId) {
                document.getElementById('submissionsList').innerHTML = '';
                document.getElementById('exportSection').style.display = 'none';
                return;
            }

            document.getElementById('exportSection').style.display = 'block';

            try {
                const submissionsResponse = await fetch(`${API_URL}/submissions?assignment_id=${assignmentId}`);
                const submissions = await submissionsResponse.json();

                const rubricsResponse = await fetch(`${API_URL}/rubrics?assignment_id=${assignmentId}`);
                currentAssignmentRubrics = await rubricsResponse.json();

                const html = submissions.map(s => `
                    <div class="card">
                        <h3>${s.student_name} (${s.student_unique_id})</h3>
                        <p><strong>Submitted:</strong> ${new Date(s.submitted_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> <span class="badge ${s.status === 'graded' ? 'badge-success' : 'badge-warning'}">${s.status}</span></p>
                        <p><strong>Submission:</strong> ${s.submission_text || 'No text provided'}</p>
                        ${s.file_path ? `<p><strong>File:</strong> ${s.file_path}</p>` : ''}

                        ${s.status === 'submitted' ? generateGradingForm(s.submission_id) : '<p style="color: #00b894;">âœ… Already graded</p>'}
                    </div>
                `).join('');

                document.getElementById('submissionsList').innerHTML = html || '<p>No submissions yet.</p>';

                const pending = submissions.filter(s => s.status === 'submitted').length;
                document.getElementById('submissionCount').textContent = pending;
            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        function generateGradingForm(submissionId) {
            if (currentAssignmentRubrics.length > 0) {
                const criteriaHTML = currentAssignmentRubrics.map(r => `
                    <div class="criterion-grade">
                        <h4>${r.criterion_name} (Max: ${r.max_points} pts)</h4>
                        ${r.description ? `<p style="color: #666; font-size: 13px;">${r.description}</p>` : ''}
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Points Earned</label>
                            <input type="number" id="rubric_${submissionId}_${r.rubric_id}"
                                   min="0" max="${r.max_points}" step="0.5"
                                   placeholder="0-${r.max_points}">
                        </div>
                        <div class="form-group">
                            <label>Feedback for this criterion</label>
                            <textarea id="feedback_${submissionId}_${r.rubric_id}"
                                      placeholder="Provide feedback for ${r.criterion_name}..."></textarea>
                        </div>
                    </div>
                `).join('');

                return `
                    <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin-top: 15px;">
                        <h4>Grade Using Rubric</h4>
                        <p style="color: #666; margin-bottom: 15px;">Grade each criterion individually:</p>
                        ${criteriaHTML}
                        <div class="form-group" style="margin-top: 20px;">
                            <label>Overall Feedback (Optional)</label>
                            <textarea id="overall_feedback_${submissionId}"
                                      placeholder="Provide overall comments about the submission..."></textarea>
                        </div>
                        <button class="btn-secondary" onclick="gradeWithRubric(${submissionId})">Submit Grade</button>
                    </div>
                `;
            } else {
                return `
                    <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin-top: 15px;">
                        <h4>Grade This Submission</h4>
                        <div class="form-group">
                            <label>Points Earned (out of 100)</label>
                            <input type="number" id="points_${submissionId}" min="0" max="100" placeholder="e.g., 85">
                        </div>
                        <div class="form-group">
                            <label>Feedback / Comments</label>
                            <textarea id="feedback_${submissionId}"
                                      placeholder="Provide detailed feedback to the student..."></textarea>
                        </div>
                        <button class="btn-secondary" onclick="gradeSimple(${submissionId})">Submit Grade</button>
                    </div>
                `;
            }
        }

        async function gradeWithRubric(submissionId) {
            try {
                let totalPoints = 0;

                for (const rubric of currentAssignmentRubrics) {
                    const points = parseFloat(document.getElementById(`rubric_${submissionId}_${rubric.rubric_id}`).value || 0);
                    const feedback = document.getElementById(`feedback_${submissionId}_${rubric.rubric_id}`).value;

                    totalPoints += points;

                    await fetch(`${API_URL}/grades`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            submission_id: submissionId,
                            rubric_id: rubric.rubric_id,
                            points_earned: points,
                            feedback: feedback,
                            graded_by: currentUser.user_id
                        })
                    });
                }

                const overallFeedback = document.getElementById(`overall_feedback_${submissionId}`).value;
                await fetch(`${API_URL}/overall-grades`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        submission_id: submissionId,
                        total_points: totalPoints,
                        overall_feedback: overallFeedback,
                        graded_by: currentUser.user_id
                    })
                });

                showMessage('Grade submitted successfully with rubric breakdown! âœ…');
                loadSubmissions();
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function gradeSimple(submissionId) {
            const points = document.getElementById(`points_${submissionId}`).value;
            const feedback = document.getElementById(`feedback_${submissionId}`).value;

            if (!points) {
                showMessage('Please enter points earned', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/grades`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        submission_id: submissionId,
                        rubric_id: null,
                        points_earned: parseFloat(points),
                        feedback: feedback,
                        graded_by: currentUser.user_id
                    })
                });

                await fetch(`${API_URL}/overall-grades`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        submission_id: submissionId,
                        total_points: parseFloat(points),
                        overall_feedback: feedback,
                        graded_by: currentUser.user_id
                    })
                });

                showMessage('Grade submitted successfully! âœ…');
                loadSubmissions();
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function exportGradesCSV() {
            if (!currentAssignmentId) {
                showMessage('Please select an assignment first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/grades/export/${currentAssignmentId}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `grades_assignment_${currentAssignmentId}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showMessage('CSV exported successfully! ðŸ“Š');
                } else {
                    showMessage('Failed to export CSV', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function enrollStudent(event) {
            event.preventDefault();

            const classId = document.getElementById('enrollClass').value;
            const studentEmail = document.getElementById('studentEmail').value;

            if (!classId) {
                showMessage('Please select a class first', 'error');
                return;
            }

            if (!studentEmail) {
                showMessage('Please enter student email', 'error');
                return;
            }

            const data = {
                class_id: parseInt(classId),
                student_email: studentEmail
            };

            try {
                const response = await fetch(`${API_URL}/enrollments`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Student enrolled successfully! âœ…');
                    document.getElementById('studentEmail').value = '';
                    loadEnrolledStudents();
                } else {
                    showMessage(result.error || 'Enrollment failed', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function loadEnrolledStudents() {
            const classId = document.getElementById('enrollClass').value;

            if (!classId) {
                document.getElementById('enrolledStudentsList').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/classes/${classId}/students`);
                const students = await response.json();

                const html = students.map(s => `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>${s.first_name} ${s.last_name}</h3>
                                <p><strong>Student ID:</strong> ${s.unique_id}</p>
                                <p><strong>Email:</strong> ${s.email}</p>
                                <span class="badge badge-success">âœ“ Enrolled</span>
                            </div>
                            <button class="btn-danger" onclick="unenrollStudent(${s.enrollment_id}, '${s.first_name} ${s.last_name}')">
                                Remove from Class
                            </button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('enrolledStudentsList').innerHTML = html || '<p>No students enrolled yet.</p>';
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function unenrollStudent(enrollmentId, studentName) {
            if (!confirm(`Remove ${studentName} from this class?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/enrollments/${enrollmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage(`${studentName} removed from class successfully!`);
                    loadEnrolledStudents();
                } else {
                    showMessage('Failed to remove student', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        checkAuth();
    </script>
</body>
</html>
